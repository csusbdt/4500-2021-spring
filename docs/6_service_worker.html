<html>
<head>
	<link rel="shortcut icon" type="image/png" href="images/icon-192x192.png">
</head>
<body>
	<div>
		Experiment 6: service worker support, V19
	</div>
	<div>
		<button id="g_fetch_button">fetch</button><br>
		<button id="g_decode_button">decode</button><br>
		<button id="g_play_button">play</button><br>
		<button id="g_increase_volume_button">increase volume</button><br>
		<button id="g_stop_button">stop</button><br>
		<button id="g_release_button">release memory</button><br>
		<div id="g_messages_div"></div>
	</div>
	<script type="module">
		import './3_error.js';
		import { c_sound } from './6_sound.js';

		/*	global g_fetch_button */
		/*	global g_decode_button */
		/*	global g_play_button */
		/*	global g_increase_volume_button */
		/*	global g_stop_button */
		/*	global g_release_button */
		/*	global g_message */
		/*	global g_start */

		if (location.protocol !== 'https:') location.protocol = 'https:';

		/*	global g_messages_div */
		window.g_message = function(...messages) {
			messages.forEach(m => g_messages_div.innerHTML += "<br>" + m);
		}

		window.g_start = function() {
			g_message("started");
			const music = new c_sound('music/robins_and_roses.mp3', .5);
			const click = new c_sound('sfx/click.mp3', 1);

			g_fetch_button.addEventListener('click', () => {
				click.fast_play();
				music.fetch()
				.then(() => g_message("fetched"))
				.catch(() => {});
			}, { capture: true, once: false });

			g_decode_button.addEventListener('click', () => {
				click.fast_play();
				music.decode()
				.then(() => g_message("decoded"))
				.catch(() => {});
			}, { capture: true, once: false });

			g_play_button.addEventListener('click', () => {
				click.fast_play();
				music.play();
				g_message("played");
			}, { capture: true, once: false });

			g_increase_volume_button.addEventListener('click', () => {
				click.fast_play();
				music.set_volume(1);
				g_message("volume set");
			}, { capture: true, once: false });

			g_stop_button.addEventListener('click', () => {
				click.fast_play();
				music.stop();
				g_message("stopped");
			}, { capture: true, once: false });

			g_release_button.addEventListener('click', () => {
				click.fast_play();
				music.release_memory();
				g_message("memory released");
			}, { capture: true, once: false });
		}

		function if_new_service_worker(registration) {
			registration.addEventListener('updatefound', function() {
				g_message("new service worker installing")
				registration.installing.addEventListener('statechange', e => {
					g_message("statechange to: " + e.target.state);
					if(e.target.state === 'activated') {
						g_message("will reload");
						window.location.reload();
					}
				});
			});
		}

		window.addEventListener('load', function() {
			if ('serviceWorker' in navigator) {	
				navigator.serviceWorker.register('sw.js')
				.then(if_new_service_worker)
				.then(navigator.serviceWorker.ready)
				.then(window.g_start)
				.catch(reason => { 
					g_message(reason);
					g_start();
				});
			} else {
				g_message("service workers not supported");
				g_start();
			}
		});

	</script>
</body>
</html>
