import{load_script,insert,remove}from"/4500-2021-spring/static/utils.js";import{set_room}from"/4500-2021-spring/static/core.js";import{c_zone}from"/4500-2021-spring/static/zone.js";import{c_sound}from"/4500-2021-spring/static/c_sound.js";import{c_sprites}from"/4500-2021-spring/static/c_sprites.js";export const rooms_to_load=new Map;export function c_room(o){this.name=o,this.bg=null,this.on_start=null,this.loadables=new Array,this.zones=new Array,this.updatables=new Array,this.drawables=new Array,this.touched=!1,this.touch_x=0,this.touch_y=0}const rooms=new Map;rooms.set("",new c_room(""));export const get_room=o=>{if(rooms.has(o))return Promise.resolve(rooms.get(o));if(rooms_to_load.has(o))return Promise.reject(`${o} under construction`);{const t=new c_room(o);return rooms_to_load.set(o,t),load_script(`/4500-2021-spring/dynamic/r_${o}.js`).then((r=>(rooms_to_load.delete(o),rooms.set(o,t),t))).catch((t=>{rooms_to_load.delete(o)}))}};c_room.prototype.insert_updatable=function(o){this.updatables.push(o)},c_room.prototype.insert_drawable=function(o){insert(this.drawables,o)},c_room.prototype.remove_updatable=function(o){remove(this.updatables,o)},c_room.prototype.remove_drawable=function(o){remove(this.drawables,o)},c_room.prototype.on_touch=function([o,t]){this.touch_x=o,this.touch_y=t,this.touched=!0},c_room.prototype.render=function(o,t){for(let o of this.drawables)o.draw(t);if(this.touched){for(let o of this.zones)if(o.contains(this.touch_x,this.touch_y)){o.touch();break}this.touched=!1}let r=Array.from(this.updatables);for(let t of r)t.update(o);r=null},c_room.prototype.start=function(){set_room(this),null!==this.on_start&&this.on_start()},c_room.prototype.stop=function(){return set_room(null),this.loadables.forEach((o=>o.unload())),Promise.resolve(this)},c_room.prototype.goto=function(o){let t=null;return get_room(o).then((o=>(t=o,Promise.all(t.loadables.map((o=>o.load())))))).then((o=>this.stop())).then((o=>t.start()))},c_room.prototype.zone=function(o){return new c_zone(this,o)},c_room.prototype.sound=function(o,t){const r=new c_sound(o,t);return this.loadables.push(r),r},c_room.prototype.sprites=function(o){const t=new c_sprites(o);return t.room=this,this.loadables.push(t),t};