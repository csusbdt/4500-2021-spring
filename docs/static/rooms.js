import{get_spritesheet}from"/4500-2021-spring/static/spritesheets.js";import{load_script,insert,remove}from"/4500-2021-spring/static/utils.js";import{set_room,set_bg}from"/4500-2021-spring/static/core.js";import{c_zone}from"/4500-2021-spring/static/zone.js";import{c_sound}from"/4500-2021-spring/static/c_sound.js";import{c_goto}from"/4500-2021-spring/static/goto.js";import{c_once}from"/4500-2021-spring/static/c_once.js";export function c_room(o){this.name=o,this.on_start=null,this.spritesheets=new Array,this.sounds=new Array,this.zones=new Array,this.updatables=new Array,this.drawables=new Array,this.touched=!1,this.touch_x=0,this.touch_y=0,this.on_loaded=null}export const rooms=new Map;window.g={rooms:rooms};const start_room=new c_room("");start_room.on_start=()=>{},rooms.set("",start_room);export function get_room(o){let t=rooms.get(o);return void 0===t?(t=new c_room(o),rooms.set(o,t),load_script(`/4500-2021-spring/dynamic/r_${o}.js`).then((()=>Promise.all(t.spritesheets.map((o=>o.load())),t.sounds.map((o=>o.fetch()))))).then((()=>(null!==t.on_loaded&&t.on_loaded(),t)))):Promise.resolve(t)}c_room.prototype.goto=function(o){return new c_goto(this,o)},c_room.prototype.zone=function(o){return new c_zone(this,o)},c_room.prototype.sound=function(o,t){const s=new c_sound(o,t);return this.sounds.push(s),s},c_room.prototype.spritesheet=function(o){const t=get_spritesheet(o);return this.spritesheets.push(t),t},c_room.prototype.once=function(o,...t){const s=new c_once(this);return t.forEach((t=>s.add(o.frame(t)))),s},c_room.prototype.bg=function(o){set_bg(o)},c_room.prototype.insert_updatable=function(o){this.updatables.push(o)},c_room.prototype.insert_drawable=function(o){insert(this.drawables,o)},c_room.prototype.remove_updatable=function(o){remove(this.updatables,o)},c_room.prototype.remove_drawable=function(o){remove(this.drawables,o)},c_room.prototype.on_touch=function([o,t]){this.touch_x=o,this.touch_y=t,this.touched=!0},c_room.prototype.start=function(){set_room(this),null!==this.on_start&&this.on_start()},c_room.prototype.stop=function(){set_bg(null),set_room(null),this.drawables.length=0,this.updatables.length=0,this.zones.length=0,this.sounds.forEach((o=>o.release_memory()))},c_room.prototype.render=function(o,t){for(let o of this.drawables)o.draw(t);if(this.touched){for(let o of this.zones)if(o.contains(this.touch_x,this.touch_y)){o.touch();break}this.touched=!1}let s=Array.from(this.updatables);for(let t of s)t.update(o);s=null};